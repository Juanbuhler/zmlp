<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layout" xmlns:th="http://www.thymeleaf.org">
<head></head>
<body>

<div th:fragment="view_modal">
<div class="modal modal-wide fade" id="viewModal" tabindex="-1" role="dialog" aria-labelledby="viewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Task</h4>
            </div>
            <div class="modal-body">
                <pre id="log"></pre>
            </div>
        </div>
    </div>
    <script th:inline="javascript" type="text/javascript">
        $(document).ready(function() {
            $('#viewModal').on('show.bs.modal', function(e) {

                //get data-id attribute of the clicked element
                var taskId = $(e.relatedTarget).data('id');
                $.ajax({
                    url : "/api/v1/tasks/" + taskId + "/_log",
                    dataType: "text",
                    success : function (data) {
                        $("#log").text(data);
                    }
                });
            });
        });
    </script>

</div>
<script th:inline="javascript" type="text/javascript">
$(function(){
    $('#viewModal').modal({
    backdrop: "static"});

}).on('show', function(){ //subscribe to show method
    var getIdFromRow = $(event.target).closest('tr').data('id'); //get the id from tr
    //make your ajax call populate items or what even you need
    $(this).find('#taskDetails').html($('Task ' + getIdFromRow))
    });
});
</script>
</div>

<div th:fragment="state_label">
    <th:block th:if="${task.state.name()} eq 'Running'">
        <span class="label label-warning">Running</span>
    </th:block>
    <th:block th:if="${task.state.name()} eq 'Waiting'">
        <span class="label label-primary">Waiting</span>
    </th:block>
    <th:block th:if="${task.state.name()} eq 'Queued'">
        <span class="label label-primary">Queued</span>
    </th:block>
    <th:block th:if="${task.state.name()} eq 'Success'">
        <span class="label label-success">Success</span>
    </th:block>
    <th:block th:if="${task.state.name()} eq 'Failure'">
        <span class="label label-danger">Failure</span>
    </th:block>
</div>

<div th:fragment="task_table">
    <table id="table" class="table table-striped table-hover">
        <thead>
        <tr>
            <th>Id</th>
            <th>Name</th>
            <th>State</th>
            <th>Duration</th>
            <th>Host</th>
        </tr>
        </thead>
        <tbody>
        <tr class="clickable-row" th:attr="data-id=${task.taskId}" data-toggle="modal" data-target="#viewModal" th:each="task: ${tasks}">
            <td class="vert-align" th:text="${task.taskId}"></td>
            <td class="vert-align" th:text="${task.name}"></td>
            <td class="vert-align">
                <div th:include="fragments/tasks :: state_label"/>
            </td>
            <td class="vert-align" th:text="${task.duration()}"></td>
            <td class="vert-align" th:text="${task.host}"></td>
        </tr>
        </tbody>
    </table>
    <div class="container-fluid">
        <div th:include="fragments/table :: pager"/>
    </div>
    <div th:include="fragments/tasks :: view_modal"/>
    <div th:include="fragments/table :: clickable_view_modal"/>
</div>



</body>
</html>
