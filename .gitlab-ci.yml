image: docker:19-dind
services:
  - docker:19-dind
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://localhost:2375
  LOCAL_ES_NAME: $CI_REGISTRY_IMAGE/elasticsearch:$CI_COMMIT_SHORT_SHA

stages:
  - build
  - pretest
  - test
  - push
  - deploy

include:
  - local: './gitlab-ci/metrics.yml'
  - local: './gitlab-ci/sdk.yml'
  - local: './gitlab-ci/services.yml'
  - local: './gitlab-ci/wallet.yml'

plugin-container-tests:
  image: boonai/docker-buildx
  stage: test
  services:
    - docker:19-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://localhost:2375
  retry: 2
  before_script:
    - apk add docker-compose
    - docker login -u "$DOCKERHUB_USER" -p "$DOCKERHUB_PASS"
  script:
    - ./buildx --plugins
    - docker run -v ${PWD}/test-data:/test-data boonai/plugins-core:latest pytest -s /boonai/pylib
    - docker run -v ${PWD}/test-data:/test-data boonai/plugins-analysis:latest pytest -s /boonai/pylib
    - docker run -v ${PWD}/test-data:/test-data boonai/plugins-train:latest pytest -s /boonai/pylib
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # MR to any branch that is not master with Boon AI changes
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "master"
      changes:
        - "client/boonsdk/**/*"
        - "containers/**/*"
    # MR to QA with any change
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"
      changes:
        - "**/*"

boonai-dockerhub-build-push-latest:
  image: boonai/docker-buildx
  stage: push
  services:
    - docker:19-dind
  variables:
    FF_USE_LEGACY_KUBERNETES_EXECUTION_STRATEGY: "false" # This feature flag fixes a bug where the job would stop and say it succeeded.
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://localhost:2375
    SOURCE_TAG: latest
    DOCKER_TAG: latest
  retry: 2
  before_script:
    - apk add docker-compose
    - docker login -u "$DOCKERHUB_USER" -p "$DOCKERHUB_PASS"
  script:
    - ./buildx -t 1
    - docker tag boonai/archivist:${SOURCE_TAG} boonai/archivist:${DOCKER_TAG}
    - docker tag boonai/officer:${SOURCE_TAG} boonai/officer:${DOCKER_TAG}
    - docker tag boonai/elasticsearch:${SOURCE_TAG} boonai/elasticsearch:${DOCKER_TAG}
    - docker tag boonai/authserver:${SOURCE_TAG} boonai/authserver:${DOCKER_TAG}
    - docker tag boonai/apigateway:${SOURCE_TAG} boonai/apigateway:${DOCKER_TAG}
    - docker tag boonai/py3-base:${SOURCE_TAG} boonai/py3-base:${DOCKER_TAG}
    - docker tag boonai/boonsdk:${SOURCE_TAG} boonai/boonsdk:${DOCKER_TAG}
    - docker tag boonai/boonlab:${SOURCE_TAG} boonai/boonlab:${DOCKER_TAG}
    - docker tag boonai/boonflow:${SOURCE_TAG} boonai/boonflow:${DOCKER_TAG}
    - docker tag boonai/boondocks:${SOURCE_TAG} boonai/boondocks:${DOCKER_TAG}
    - docker tag boonai/plugins-models:${SOURCE_TAG} boonai/plugins-models:${DOCKER_TAG}
    - docker tag boonai/plugins-core:${SOURCE_TAG} boonai/plugins-core:${DOCKER_TAG}
    - docker tag boonai/plugins-analysis:${SOURCE_TAG} boonai/plugins-analysis:${DOCKER_TAG}
    - docker tag boonai/analyst:${SOURCE_TAG} boonai/analyst:${DOCKER_TAG}
    - docker tag boonai/ml-bbq:${SOURCE_TAG} boonai/ml-bbq:${DOCKER_TAG}
    - docker tag boonai/plugins-train:${SOURCE_TAG} boonai/plugins-train:${DOCKER_TAG}
    - docker tag boonai/reporter:${SOURCE_TAG} boonai/reporter:${DOCKER_TAG}
    - docker push boonai/archivist:${DOCKER_TAG}
    - docker push boonai/officer:${DOCKER_TAG}
    - docker push boonai/elasticsearch:${DOCKER_TAG}
    - docker push boonai/authserver:${DOCKER_TAG}
    - docker push boonai/apigateway:${DOCKER_TAG}
    - docker push boonai/py3-base:${DOCKER_TAG}
    - docker push boonai/boonsdk:${DOCKER_TAG}
    - docker push boonai/boonlab:${DOCKER_TAG}
    - docker push boonai/boonflow:${DOCKER_TAG}
    - docker push boonai/boondocks:${DOCKER_TAG}
    - docker push boonai/plugins-models:${DOCKER_TAG}
    - docker push boonai/plugins-core:${DOCKER_TAG}
    - docker push boonai/plugins-analysis:${DOCKER_TAG}
    - docker push boonai/analyst:${DOCKER_TAG}
    - docker push boonai/ml-bbq:${DOCKER_TAG}
    - docker push boonai/plugins-train:${DOCKER_TAG}
    - docker push boonai/reporter:${DOCKER_TAG}
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Merged to development with Boon AI changes
    - if: $CI_COMMIT_BRANCH == "development"
      changes:
        - "client/**/*"
        - "containers/**/*"
        - "dev/**/*"
        - "services/analyst/**/*"
        - "services/jvm-common/**/*"
        - "services/api-gateway/**/*"
        - "services/archivist/**/*"
        - "services/auth-server/**/*"
        - "services/elasticsearch/**/*"
        - "services/mlbbq/**/*"
        - "services/officer/**/*"
        - "services/reporter/**/*"

boonai-dockerhub-build-push-qa:
  extends:
    - boonai-dockerhub-build-push-latest
  variables:
    DOCKER_TAG: qa
  rules:
    # Merged to QA with any change
    - if: $CI_COMMIT_BRANCH == "qa"
      changes:
        - "**/*"

boonai-deploy-development:
  image: google/cloud-sdk
  retry: 1
  variables:
    PROJECT: zvi-dev
  stage: deploy
  environment:
    name: dev
    url: https://dev.console.zvi.zorroa.com/
  before_script:
    - echo $DEV_SA_JSON > ./sa.json
    - gcloud auth activate-service-account $SA_EMAIL --key-file=./sa.json
    - gcloud container clusters get-credentials zmlp --zone us-central1-a --project ${PROJECT}
  script:
    - kubectl --namespace default rollout restart deployment analyst api-gateway archivist auth-server officer ml-bbq reporter
    - kubectl --namespace default rollout restart statefulset elasticsearch-master elasticsearch-data
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Merged to development with Boon AI changes
    - if: $CI_COMMIT_BRANCH == "development"
      changes:
        - "client/**/*"
        - "containers/**/*"
        - "dev/**/*"
        - "services/**/*"

boonai-deploy-qa:
  extends:
    - boonai-deploy-development
  environment:
    name: qa
    url: https://qa.console.zvi.zorroa.com/
  variables:
    PROJECT: zvi-qa
  before_script:
    - echo $QA_SA_JSON > ./sa.json
    - gcloud auth activate-service-account $SA_EMAIL --key-file=./sa.json
    - gcloud container clusters get-credentials zmlp --zone us-central1-a --project ${PROJECT}
  rules:
    # Merged to QA with any change
    - if: $CI_COMMIT_BRANCH == "qa"
      changes:
        - "**/*"

# Production Push and Deploy
boonai-dockerhub-build-push-prod:
  image: boonai/docker-buildx
  stage: push
  services:
    - docker:19-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://localhost:2375
    SOURCE_TAG: qa
    DOCKER_TAG: stable
  retry: 2
  before_script:
    - apk add docker-compose
    - docker login -u "$DOCKERHUB_USER" -p "$DOCKERHUB_PASS"
  script:
    - docker pull -q boonai/archivist:${SOURCE_TAG}
    - docker pull -q boonai/officer:${SOURCE_TAG}
    - docker pull -q boonai/elasticsearch:${SOURCE_TAG}
    - docker pull -q boonai/authserver:${SOURCE_TAG}
    - docker pull -q boonai/apigateway:${SOURCE_TAG}
    - docker pull -q boonai/py3-base:${SOURCE_TAG}
    - docker pull -q boonai/boonsdk:${SOURCE_TAG}
    - docker pull -q boonai/boonlab:${SOURCE_TAG}
    - docker pull -q boonai/boonflow:${SOURCE_TAG}
    - docker pull -q boonai/boondocks:${SOURCE_TAG}
    - docker pull -q boonai/plugins-models:${SOURCE_TAG}
    - docker pull -q boonai/plugins-core:${SOURCE_TAG}
    - docker pull -q boonai/plugins-analysis:${SOURCE_TAG}
    - docker pull -q boonai/analyst:${SOURCE_TAG}
    - docker pull -q boonai/ml-bbq:${SOURCE_TAG}
    - docker pull -q boonai/plugins-train:${SOURCE_TAG}
    - docker pull -q boonai/wallet:${SOURCE_TAG}
    - docker pull -q boonai/reporter:${SOURCE_TAG}
    - docker pull -q boonai/metrics:${SOURCE_TAG}
    - docker tag boonai/archivist:${SOURCE_TAG} boonai/archivist:${DOCKER_TAG}
    - docker tag boonai/officer:${SOURCE_TAG} boonai/officer:${DOCKER_TAG}
    - docker tag boonai/elasticsearch:${SOURCE_TAG} boonai/elasticsearch:${DOCKER_TAG}
    - docker tag boonai/authserver:${SOURCE_TAG} boonai/authserver:${DOCKER_TAG}
    - docker tag boonai/apigateway:${SOURCE_TAG} boonai/apigateway:${DOCKER_TAG}
    - docker tag boonai/py3-base:${SOURCE_TAG} boonai/py3-base:${DOCKER_TAG}
    - docker tag boonai/boonsdk:${SOURCE_TAG} boonai/boonsdk:${DOCKER_TAG}
    - docker tag boonai/boonlab:${SOURCE_TAG} boonai/boonlab:${DOCKER_TAG}
    - docker tag boonai/boonflow:${SOURCE_TAG} boonai/boonflow:${DOCKER_TAG}
    - docker tag boonai/boondocks:${SOURCE_TAG} boonai/boondocks:${DOCKER_TAG}
    - docker tag boonai/plugins-models:${SOURCE_TAG} boonai/plugins-models:${DOCKER_TAG}
    - docker tag boonai/plugins-core:${SOURCE_TAG} boonai/plugins-core:${DOCKER_TAG}
    - docker tag boonai/plugins-analysis:${SOURCE_TAG} boonai/plugins-analysis:${DOCKER_TAG}
    - docker tag boonai/analyst:${SOURCE_TAG} boonai/analyst:${DOCKER_TAG}
    - docker tag boonai/ml-bbq:${SOURCE_TAG} boonai/ml-bbq:${DOCKER_TAG}
    - docker tag boonai/plugins-train:${SOURCE_TAG} boonai/plugins-train:${DOCKER_TAG}
    - docker tag boonai/wallet:${SOURCE_TAG} boonai/wallet:${DOCKER_TAG}
    - docker tag boonai/reporter:${SOURCE_TAG} boonai/reporter:${DOCKER_TAG}
    - docker tag boonai/metrics:${SOURCE_TAG} boonai/metrics:${DOCKER_TAG}
    - docker push boonai/archivist:${DOCKER_TAG}
    - docker push boonai/officer:${DOCKER_TAG}
    - docker push boonai/elasticsearch:${DOCKER_TAG}
    - docker push boonai/authserver:${DOCKER_TAG}
    - docker push boonai/apigateway:${DOCKER_TAG}
    - docker push boonai/py3-base:${DOCKER_TAG}
    - docker push boonai/boonsdk:${DOCKER_TAG}
    - docker push boonai/boonlab:${DOCKER_TAG}
    - docker push boonai/boonflow:${DOCKER_TAG}
    - docker push boonai/boondocks:${DOCKER_TAG}
    - docker push boonai/plugins-models:${DOCKER_TAG}
    - docker push boonai/plugins-core:${DOCKER_TAG}
    - docker push boonai/plugins-analysis:${DOCKER_TAG}
    - docker push boonai/analyst:${DOCKER_TAG}
    - docker push boonai/ml-bbq:${DOCKER_TAG}
    - docker push boonai/plugins-train:${DOCKER_TAG}
    - docker push boonai/wallet:${DOCKER_TAG}
    - docker push boonai/reporter:${DOCKER_TAG}
    - docker push boonai/metrics:${DOCKER_TAG}
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual

boonai-deploy-prod:
  image: google/cloud-sdk
  variables:
    PROJECT: zvi-prod
  stage: deploy
  environment:
    name: prod
    url: https://console.zvi.zorroa.com/
  before_script:
    - echo $PROD_SA_JSON > ./sa.json
    - gcloud auth activate-service-account $SA_EMAIL --key-file=./sa.json
    - gcloud container clusters get-credentials zmlp --zone us-central1-a --project ${PROJECT}
  script:
    - kubectl --namespace default rollout restart deployment wallet analyst api-gateway archivist auth-server officer ml-bbq reporter metrics
    - kubectl --namespace default rollout restart statefulset elasticsearch-master elasticsearch-data
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual
