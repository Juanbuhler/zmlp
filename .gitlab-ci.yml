stages:
  - build
  - pretest
  - test
  - push
  - deploy

variables:
  DOCKERHUB_IMAGE_ARCHIVIST: zorroaevi/archivist:$CI_COMMIT_REF_SLUG
  DOCKERHUB_IMAGE_ELASTIC: zorroaevi/elasticsearch:$CI_COMMIT_REF_SLUG
  LOCAL_ES_NAME: $CI_REGISTRY_IMAGE/elasticsearch:$CI_COMMIT_SHORT_SHA
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://localhost:2375

build_artifacts:
  image: maven:3.6.0-jdk-8-slim
  stage: build
  only:
    - merge_requests
    - development
  script:
      - cd es-similarity
      - mvn package
      - cd ../
      - cp es-similarity/target/releases/es-similarity.zip elasticsearch
      - cd es-kwconf
      - mvn package
      - cd ../
      - cp es-kwconf/target/releases/es-kwconf.zip elasticsearch
      - mvn clean install -Dmaven.test.skip=true
  artifacts:
    paths:
      - archivist/target/*.jar
      - elasticsearch/*.zip
      - archivist/ext/*.jar

push_to_local_registry:
  image: docker:stable
  stage: pretest
  only:
    - merge_requests
    - development
  retry: 2
  services:
    - docker:dind
  script:
    - cd elasticsearch
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - docker build -t $LOCAL_ES_NAME .
    - docker push $LOCAL_ES_NAME

linting:
  image: java:latest
  stage: test
  only:
    - merge_requests
    - development
  allow_failure: true
  script:
    - apk update && apk add ca-certificates wget && update-ca-certificates
    - wget https://github.com/shyiko/ktlint/releases/download/0.31.0/ktlint
    - chmod a+x ktlint
    - DIFF=$(git diff --name-only --diff-filter=b $(git merge-base $CI_COMMIT_SHA development))
    - echo $DIFF
    - ./ktlint $DIFF

unit_tests:
  stage: test
  image: maven:3.6.0-jdk-8-alpine
  only:
    - merge_requests
    - development
  services:
    - name: postgres:9.6.9
      alias: postgres
    - name: $LOCAL_ES_NAME
      alias: elasticsearch
      command: [ "bin/elasticsearch", "-Ediscovery.type=single-node"]
  variables:
    POSTGRES_PASSWORD: zorroa
    POSTGRES_USER: zorroa
    POSTGRES_DB: zorroa
    PGDATA: /var/lib/postgresql/data/pgdata
    SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres:5432/zorroa?currentSchema=unittest40"
    LOGGING_LEVEL_COM_ZORROA: WARN
    USER: gitlab
  script:
    - mvn test -q
  after_script:
    - awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, " instructions covered"; print 100*covered/instructions, "% code coverage" }' archivist/target/site/jacoco/jacoco.csv

docker_hub_push:
  stage: push
  retry: 2
  only:
    - development
  image: docker:stable
  services:
    - docker:dind
  script:
    - cd archivist
    - docker build --pull -t $DOCKERHUB_IMAGE_ARCHIVIST .
    - docker login -u "$DOCKERHUB_USER" -p "$DOCKERHUB_PASS"
    - docker push $DOCKERHUB_IMAGE_ARCHIVIST
    - cd ../elasticsearch
    - docker build --pull -t $DOCKERHUB_IMAGE_ELASTIC .
    - docker login -u "$DOCKERHUB_USER" -p "$DOCKERHUB_PASS"
    - docker push $DOCKERHUB_IMAGE_ELASTIC

deploy_archivist_dev:
  image: google/cloud-sdk
  stage: deploy
  environment:
    name: development
    url: https://dev.zorroa.com
  only:
    - development
  script:
    - echo $DEV_SA_JSON > ./sa.json
    - gcloud auth activate-service-account $DEV_SA_EMAIL --key-file=./sa.json
    - gcloud container clusters get-credentials zorroa --zone us-central1-a --project zorroa-dev
    - kubectl patch deployment archivist -p "{\"spec\":{\"template\":{\"metadata\":{\"labels\":{\"commit\":\"$CI_COMMIT_SHA\"}}}}}" --namespace=default

deploy_elasticsearch_dev:
  image: google/cloud-sdk
  stage: deploy
  environment:
    name: development
    url: https://dev.zorroa.com
  only:
    - development
  script:
    - echo $DEV_SA_JSON > ./sa.json
    - gcloud auth activate-service-account $DEV_SA_EMAIL --key-file=./sa.json
    - gcloud container clusters get-credentials zorroa --zone us-central1-a --project zorroa-dev
    - kubectl patch statefulset elasticsearch -p "{\"spec\":{\"template\":{\"metadata\":{\"labels\":{\"commit\":\"$CI_COMMIT_SHA\"}}}}}" --namespace=default
