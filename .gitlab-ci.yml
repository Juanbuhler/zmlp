image: docker:19-dind
services:
  - docker:19-dind
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://localhost:2375
  LOCAL_ES_NAME: $CI_REGISTRY_IMAGE/elasticsearch:$CI_COMMIT_SHORT_SHA

stages:
  - build
  - pretest
  - test
  - push
  - deploy

########  Wallet  ########

## Wallet Integration CI Tests
wallet-integration-test-suite:
  stage: test
  image: cypress/browsers:node14.7.0-chrome84
  before_script:
    - cd applications/wallet/cypress
    - npm ci
  script:
    - npm run cli -- --browser chrome --headless --record --group Backend --spec 'integration/backend/**/*'
    - npm run cli -- --browser chrome --headless --record --group Frontend --spec 'integration/frontend/**/*'
  artifacts:
    when: always
    paths:
      - applications/wallet/cypress/videos/**/*.mp4
      - applications/wallet/cypress/screenshots/**/*.png
    expire_in: 1 day
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
    # MR to Development with Cypress changes
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "development"
      changes:
        - "applications/wallet/cypress/**/*"

## Wallet Frontend CI Tests
wallet-frontend-test-suite:
  stage: test
  image: node:12
  before_script:
    - cd applications/wallet/frontend
    - npm ci
  script:
    - npm run lint
    - npm run test:cover
    - npm run size
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # MR to any branch that is not master with Frontend changes
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "master"
      changes:
        - "applications/wallet/frontend/**/*"
    # MR to QA with any change
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"
      changes:
        - "**/*"
    # Merged to Development with Frontend changes
    - if: $CI_COMMIT_BRANCH == "development"
      changes:
        - "applications/wallet/frontend/**/*"
    # Merged to QA with any change
    - if: $CI_COMMIT_BRANCH == "qa"
      changes:
        - "**/*"

## Wallet Backend CI Tests
wallet-backend-test-suite:
  stage: test
  image: mc706/pipenv-3.7
  services:
    - name: postgres:9.6.9
      alias: postgres
  variables:
    POSTGRES_PASSWORD: a8fnnbe934j
    POSTGRES_USER: wallet
    POSTGRES_DB: wallet
    PG_HOST: postgres
  script:
    - cd applications/wallet
    - pipenv sync
    - cd app
    - pipenv run flake8
    - pipenv run pytest --cov=.
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # MR to any branch that is not master with Backend changes
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "master"
      changes:
        - "applications/wallet/app/**/*"
        - "applications/wallet/Pipfile*"
    # MR to QA with any change
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"
      changes:
        - "**/*"
    # Merged to Development with Backend changes
    - if: $CI_COMMIT_BRANCH == "development"
      changes:
        - "applications/wallet/app/**/*"
    # Merged to QA with any change
    - if: $CI_COMMIT_BRANCH == "qa"
      changes:
        - "**/*"

## Wallet Build & Push Latest on changes to Development
wallet-dockerhub-build-push-latest:
  image: boonai/docker-buildx
  stage: push
  services:
    - docker:19-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://localhost:2375
    DOCKER_TAG: latest
  retry: 2
  before_script:
    - apk add docker-compose
    - docker login -u "$DOCKERHUB_USER" -p "$DOCKERHUB_PASS"
  script:
    - ./buildx wallet
    - docker tag boonai/wallet:latest boonai/wallet:${DOCKER_TAG}
    - docker push boonai/wallet:${DOCKER_TAG}
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Merged to Development with Wallet changes
    - if: $CI_COMMIT_BRANCH == "development"
      changes:
        - "applications/wallet/**/*"

## Wallet Build & Push QA on changes to QA branch
wallet-dockerhub-build-push-qa:
  extends:
    - wallet-dockerhub-build-push-latest
  variables:
    DOCKER_TAG: qa
  rules:
    # Merged to QA with any change
    - if: $CI_COMMIT_BRANCH == "qa"
      changes:
        - "**/*"

## Wallet Deploy Latest on any changes to Development
wallet-deploy-development:
  image: google/cloud-sdk
  retry: 1
  variables:
    PROJECT: zvi-dev
  stage: deploy
  environment:
    name: dev
    url: https://dev.console.zvi.zorroa.com/
  before_script:
    - echo $DEV_SA_JSON > ./sa.json
    - gcloud auth activate-service-account $SA_EMAIL --key-file=./sa.json
    - gcloud container clusters get-credentials zmlp --zone us-central1-a --project ${PROJECT}
  script:
    - kubectl --namespace default rollout restart deployment wallet
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Merged to development with Wallet changes
    - if: $CI_COMMIT_BRANCH == "development"
      changes:
        - "applications/wallet/**/*"

## Wallet Deploy Latest on any changes to QA
wallet-deploy-qa:
  extends:
    - wallet-deploy-development
  variables:
    PROJECT: zvi-qa
  environment:
    name: qa
    url: https://qa.console.zvi.zorroa.com/
  before_script:
    - echo $QA_SA_JSON > ./sa.json
    - gcloud auth activate-service-account $SA_EMAIL --key-file=./sa.json
    - gcloud container clusters get-credentials zmlp --zone us-central1-a --project ${PROJECT}
  rules:
    # Merged to QA with any change
    - if: $CI_COMMIT_BRANCH == "qa"
      changes:
        - "**/*"

########  Boon AI Services & Plugins  ########

## Metrics Backend Tests
metrics-backend-test-suite:
  stage: test
  image: mc706/pipenv-3.7
  services:
      - name: postgres:9.6.9
        alias: postgres
  variables:
    DJANGO_SETTINGS_MODULE: metrics.settings.testing
    DEBUG: "true"
    PG_DB_HOST: postgres
    PG_DB_USER: metrics
    PG_DB_PASSWORD: 2mAPDWhuiYdIW69u
    POSTGRES_DB: metrics
    POSTGRES_USER: metrics
    POSTGRES_PASSWORD: 2mAPDWhuiYdIW69u

  script:
    - cd services/metrics
    - pipenv sync
    - cd app
    - pipenv run flake8
    - pipenv run pytest --cov=.
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # MR to any branch that is not master with Backend changes
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "master"
      changes:
        - "services/metrics/app/**/*"
    # MR to QA with any change
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"
      changes:
        - "**/*"
    # Merged to Development with Backend changes
    - if: $CI_COMMIT_BRANCH == "development"
      changes:
        - "services/metrics/app/**/*"
    # Merged to QA with any change
    - if: $CI_COMMIT_BRANCH == "qa"
      changes:
        - "**/*"

## Metrics Build & Push Latest on changes to Development
metrics-dockerhub-build-push-latest:
  image: boonai/docker-buildx
  stage: push
  services:
    - docker:19-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://localhost:2375
    DOCKER_TAG: latest
  retry: 2
  before_script:
    - apk add docker-compose
    - docker login -u "$DOCKERHUB_USER" -p "$DOCKERHUB_PASS"
  script:
    - ./buildx metrics
    - docker tag boonai/metrics:latest boonai/metrics:${DOCKER_TAG}
    - docker push boonai/metrics:${DOCKER_TAG}
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Merged to Development with Metrics changes
    - if: $CI_COMMIT_BRANCH == "development"
      changes:
        - "services/metrics/**/*"

## Metrics Build & Push QA on changes to QA branch
metrics-dockerhub-build-push-qa:
  extends:
    - metrics-dockerhub-build-push-latest
  variables:
    DOCKER_TAG: qa
  rules:
    # Merged to QA with any change
    - if: $CI_COMMIT_BRANCH == "qa"
      changes:
        - "**/*"

## Metrics Deploy Latest on any changes to Development
metrics-deploy-development:
  image: google/cloud-sdk
  retry: 1
  variables:
    PROJECT: zvi-dev
  stage: deploy
  environment:
    name: dev
    url: https://dev.console.zvi.zorroa.com/
  before_script:
    - echo $DEV_SA_JSON > ./sa.json
    - gcloud auth activate-service-account $SA_EMAIL --key-file=./sa.json
    - gcloud container clusters get-credentials zmlp --zone us-central1-a --project ${PROJECT}
  script:
    - kubectl --namespace default rollout restart deployment metrics
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Merged to development with Metrics changes
    - if: $CI_COMMIT_BRANCH == "development"
      changes:
        - "services/metrics/**/*"

## Metrics Deploy Latest on any changes to QA
metrics-deploy-qa:
  extends:
    - metrics-deploy-development
  variables:
    PROJECT: zvi-qa
  environment:
    name: qa
    url: https://qa.console.zvi.zorroa.com/
  before_script:
    - echo $QA_SA_JSON > ./sa.json
    - gcloud auth activate-service-account $SA_EMAIL --key-file=./sa.json
    - gcloud container clusters get-credentials zmlp --zone us-central1-a --project ${PROJECT}
  rules:
    # Merged to QA with any change
    - if: $CI_COMMIT_BRANCH == "qa"
      changes:
        - "**/*"

## Backend Python Lint
backend-py-lint:
  image: python:3.7.5
  stage: pretest
  allow_failure: false
  script:
    - python -m pip install flake8
    - flake8 --config .flake8.cfg client/boonczar client/boonsdk client/boonlab containers/boonflow containers/py3-base containers/boondocks containers/plugins-core containers/plugins-analysis containers/plugins-train services/analyst services/mlbbq
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # MR to any branch that is not master with Boon AI Python changes
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "master"
      changes:
        - "client/boonsdk/**/*.py"
        - "client/boonlab/**/*.py"
        - "containers/**/*.py"
        - "services/analyst/**/*.py"
        - "services/mlbbq/**/*.py"
    # MR to QA with any change
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"
      changes:
        - "**/*"

## Backend Kotlin Lint
backend-kotlin-lint:
  image: kkopper/ktlint:0.37.2
  stage: pretest
  script:
    - ktlint services/**/*.kt lib/**/*.kt
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # MR to any branch that is not master with Boon AI Kotlin changes
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "master"
      changes:
        - "services/**/*.kt"
        - "lib/**/*.kt"
    # MR to QA with any change
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"
      changes:
        - "**/*"

# SDK Test
# Testing other containers requires building containers
# Testing analyst requires it can pull plugin containers.
sdk-unit-tests:
  image: python:3.8.5
  stage: test
  allow_failure: false
  script:
    - apt-get update
    - apt-get -y install openimageio-tools mediainfo
    - python -m pip install pipenv pytest cmake
    - pip install --upgrade pip
    - cd client/boonsdk
    - pip install .
    - pytest
    - cd ../../containers/boonflow
    - tar -xJf ffmpeg-amd64-static.tar.xz
    - cp ffmpeg-4.2.2-amd64-static/ffmpeg /usr/bin
    - cp ffmpeg-4.2.2-amd64-static/ffprobe /usr/bin
    - pip install .
    - pytest
    - cd ../boondocks
    - pip install .
    - pytest
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # MR to any branch that is not master with BOONAI changes
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "master"
      changes:
        - "client/boonsdk/**/*"
        - "client/boonlab/**/*"
        - "containers/boonflow/**/*"
        - "containers/boondocks/**/*"
    # MR to QA with any change
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"
      changes:
        - "**/*"

plugin-container-tests:
  image: boonai/docker-buildx
  stage: test
  services:
    - docker:19-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://localhost:2375
  retry: 2
  before_script:
    - apk add docker-compose
    - docker login -u "$DOCKERHUB_USER" -p "$DOCKERHUB_PASS"
  script:
    - ./buildx --plugins
    - docker run -v ${PWD}/test-data:/test-data boonai/plugins-core:latest pytest -s /boonai/pylib
    - docker run -v ${PWD}/test-data:/test-data boonai/plugins-analysis:latest pytest -s /boonai/pylib
    - docker run -v ${PWD}/test-data:/test-data boonai/plugins-train:latest pytest -s /boonai/pylib
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # MR to any branch that is not master with Boon AI changes
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "master"
      changes:
        - "client/boonsdk/**/*"
        - "containers/**/*"
    # MR to QA with any change
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"
      changes:
        - "**/*"

boonai-dockerhub-build-push-latest:
  image: boonai/docker-buildx
  stage: push
  services:
    - docker:19-dind
  variables:
    FF_USE_LEGACY_KUBERNETES_EXECUTION_STRATEGY: "false" # This feature flag fixes a bug where the job would stop and say it succeeded.
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://localhost:2375
    SOURCE_TAG: latest
    DOCKER_TAG: latest
  retry: 2
  before_script:
    - apk add docker-compose
    - docker login -u "$DOCKERHUB_USER" -p "$DOCKERHUB_PASS"
  script:
    - ./buildx -t 1
    - docker tag boonai/archivist:${SOURCE_TAG} boonai/archivist:${DOCKER_TAG}
    - docker tag boonai/officer:${SOURCE_TAG} boonai/officer:${DOCKER_TAG}
    - docker tag boonai/elasticsearch:${SOURCE_TAG} boonai/elasticsearch:${DOCKER_TAG}
    - docker tag boonai/authserver:${SOURCE_TAG} boonai/authserver:${DOCKER_TAG}
    - docker tag boonai/apigateway:${SOURCE_TAG} boonai/apigateway:${DOCKER_TAG}
    - docker tag boonai/py3-base:${SOURCE_TAG} boonai/py3-base:${DOCKER_TAG}
    - docker tag boonai/boonsdk:${SOURCE_TAG} boonai/boonsdk:${DOCKER_TAG}
    - docker tag boonai/boonlab:${SOURCE_TAG} boonai/boonlab:${DOCKER_TAG}
    - docker tag boonai/boonflow:${SOURCE_TAG} boonai/bonoflow:${DOCKER_TAG}
    - docker tag boonai/boondocks:${SOURCE_TAG} boonai/boondocks:${DOCKER_TAG}
    - docker tag boonai/plugins-models:${SOURCE_TAG} boonai/plugins-models:${DOCKER_TAG}
    - docker tag boonai/plugins-core:${SOURCE_TAG} boonai/plugins-core:${DOCKER_TAG}
    - docker tag boonai/plugins-analysis:${SOURCE_TAG} boonai/plugins-analysis:${DOCKER_TAG}
    - docker tag boonai/analyst:${SOURCE_TAG} boonai/analyst:${DOCKER_TAG}
    - docker tag boonai/ml-bbq:${SOURCE_TAG} boonai/ml-bbq:${DOCKER_TAG}
    - docker tag boonai/plugins-train:${SOURCE_TAG} boonai/plugins-train:${DOCKER_TAG}
    - docker tag boonai/reporter:${SOURCE_TAG} boonai/reporter:${DOCKER_TAG}
    - docker push boonai/archivist:${DOCKER_TAG}
    - docker push boonai/officer:${DOCKER_TAG}
    - docker push boonai/elasticsearch:${DOCKER_TAG}
    - docker push boonai/authserver:${DOCKER_TAG}
    - docker push boonai/apigateway:${DOCKER_TAG}
    - docker push boonai/py3-base:${DOCKER_TAG}
    - docker push boonai/boonsdk:${DOCKER_TAG}
    - docker push boonai/boonlab:${DOCKER_TAG}
    - docker push boonai/boonflow:${DOCKER_TAG}
    - docker push boonai/boondocks:${DOCKER_TAG}
    - docker push boonai/plugins-models:${DOCKER_TAG}
    - docker push boonai/plugins-core:${DOCKER_TAG}
    - docker push boonai/plugins-analysis:${DOCKER_TAG}
    - docker push boonai/analyst:${DOCKER_TAG}
    - docker push boonai/ml-bbq:${DOCKER_TAG}
    - docker push boonai/plugins-train:${DOCKER_TAG}
    - docker push boonai/reporter:${DOCKER_TAG}
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Merged to development with Boon AI changes
    - if: $CI_COMMIT_BRANCH == "development"
      changes:
        - "client/**/*"
        - "containers/**/*"
        - "dev/**/*"
        - "services/analyst/**/*"
        - "services/jvm-common/**/*"
        - "services/api-gateway/**/*"
        - "services/archivist/**/*"
        - "services/auth-server/**/*"
        - "services/elasticsearch/**/*"
        - "services/mlbbq/**/*"
        - "services/officer/**/*"
        - "services/reporter/**/*"

boonai-dockerhub-build-push-qa:
  extends:
    - boonai-dockerhub-build-push-latest
  variables:
    DOCKER_TAG: qa
  rules:
    # Merged to QA with any change
    - if: $CI_COMMIT_BRANCH == "qa"
      changes:
        - "**/*"

boonai-deploy-development:
  image: google/cloud-sdk
  retry: 1
  variables:
    PROJECT: zvi-dev
  stage: deploy
  environment:
    name: dev
    url: https://dev.console.zvi.zorroa.com/
  before_script:
    - echo $DEV_SA_JSON > ./sa.json
    - gcloud auth activate-service-account $SA_EMAIL --key-file=./sa.json
    - gcloud container clusters get-credentials zmlp --zone us-central1-a --project ${PROJECT}
  script:
    - kubectl --namespace default rollout restart deployment analyst api-gateway archivist auth-server officer ml-bbq reporter
    - kubectl --namespace default rollout restart statefulset elasticsearch-master elasticsearch-data
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # Merged to development with Boon AI changes
    - if: $CI_COMMIT_BRANCH == "development"
      changes:
        - "client/**/*"
        - "containers/**/*"
        - "dev/**/*"
        - "services/**/*"

boonai-deploy-qa:
  extends:
    - boonai-deploy-development
  environment:
    name: qa
    url: https://qa.console.zvi.zorroa.com/
  variables:
    PROJECT: zvi-qa
  before_script:
    - echo $QA_SA_JSON > ./sa.json
    - gcloud auth activate-service-account $SA_EMAIL --key-file=./sa.json
    - gcloud container clusters get-credentials zmlp --zone us-central1-a --project ${PROJECT}
  rules:
    # Merged to QA with any change
    - if: $CI_COMMIT_BRANCH == "qa"
      changes:
        - "**/*"

# Production Push and Deploy
boonai-dockerhub-build-push-prod:
  image: boonai/docker-buildx
  stage: push
  services:
    - docker:19-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://localhost:2375
    SOURCE_TAG: qa
    DOCKER_TAG: stable
  retry: 2
  before_script:
    - apk add docker-compose
    - docker login -u "$DOCKERHUB_USER" -p "$DOCKERHUB_PASS"
  script:
    - docker pull -q boonai/archivist:${SOURCE_TAG}
    - docker pull -q boonai/officer:${SOURCE_TAG}
    - docker pull -q boonai/elasticsearch:${SOURCE_TAG}
    - docker pull -q boonai/authserver:${SOURCE_TAG}
    - docker pull -q boonai/apigateway:${SOURCE_TAG}
    - docker pull -q boonai/py3-base:${SOURCE_TAG}
    - docker pull -q boonai/boonsdk:${SOURCE_TAG}
    - docker pull -q boonai/boonlab:${SOURCE_TAG}
    - docker pull -q boonai/boonflow:${SOURCE_TAG}
    - docker pull -q boonai/boondocks:${SOURCE_TAG}
    - docker pull -q boonai/plugins-models:${SOURCE_TAG}
    - docker pull -q boonai/plugins-core:${SOURCE_TAG}
    - docker pull -q boonai/plugins-analysis:${SOURCE_TAG}
    - docker pull -q boonai/analyst:${SOURCE_TAG}
    - docker pull -q boonai/ml-bbq:${SOURCE_TAG}
    - docker pull -q boonai/plugins-train:${SOURCE_TAG}
    - docker pull -q boonai/wallet:${SOURCE_TAG}
    - docker pull -q boonai/reporter:${SOURCE_TAG}
    - docker pull -q boonai/metrics:${SOURCE_TAG}
    - docker tag boonai/archivist:${SOURCE_TAG} boonai/archivist:${DOCKER_TAG}
    - docker tag boonai/officer:${SOURCE_TAG} boonai/officer:${DOCKER_TAG}
    - docker tag boonai/elasticsearch:${SOURCE_TAG} boonai/elasticsearch:${DOCKER_TAG}
    - docker tag boonai/authserver:${SOURCE_TAG} boonai/authserver:${DOCKER_TAG}
    - docker tag boonai/apigateway:${SOURCE_TAG} boonai/apigateway:${DOCKER_TAG}
    - docker tag boonai/py3-base:${SOURCE_TAG} boonai/py3-base:${DOCKER_TAG}
    - docker tag boonai/boonsdk:${SOURCE_TAG} boonai/boonsdk:${DOCKER_TAG}
    - docker tag boonai/boonlab:${SOURCE_TAG} boonai/boonlab:${DOCKER_TAG}
    - docker tag boonai/boonflow:${SOURCE_TAG} boonai/boonflow:${DOCKER_TAG}
    - docker tag boonai/boondocks:${SOURCE_TAG} boonai/boondocks:${DOCKER_TAG}
    - docker tag boonai/plugins-models:${SOURCE_TAG} boonai/plugins-models:${DOCKER_TAG}
    - docker tag boonai/plugins-core:${SOURCE_TAG} boonai/plugins-core:${DOCKER_TAG}
    - docker tag boonai/plugins-analysis:${SOURCE_TAG} boonai/plugins-analysis:${DOCKER_TAG}
    - docker tag boonai/analyst:${SOURCE_TAG} boonai/analyst:${DOCKER_TAG}
    - docker tag boonai/ml-bbq:${SOURCE_TAG} boonai/ml-bbq:${DOCKER_TAG}
    - docker tag boonai/plugins-train:${SOURCE_TAG} boonai/plugins-train:${DOCKER_TAG}
    - docker tag boonai/wallet:${SOURCE_TAG} boonai/wallet:${DOCKER_TAG}
    - docker tag boonai/reporter:${SOURCE_TAG} boonai/reporter:${DOCKER_TAG}
    - docker tag boonai/metrics:${SOURCE_TAG} boonai/metrics:${DOCKER_TAG}
    - docker push boonai/archivist:${DOCKER_TAG}
    - docker push boonai/officer:${DOCKER_TAG}
    - docker push boonai/elasticsearch:${DOCKER_TAG}
    - docker push boonai/authserver:${DOCKER_TAG}
    - docker push boonai/apigateway:${DOCKER_TAG}
    - docker push boonai/py3-base:${DOCKER_TAG}
    - docker push boonai/boonsdk:${DOCKER_TAG}
    - docker push boonai/boonlab:${DOCKER_TAG}
    - docker push boonai/boonflow:${DOCKER_TAG}
    - docker push boonai/boondocks:${DOCKER_TAG}
    - docker push boonai/plugins-models:${DOCKER_TAG}
    - docker push boonai/plugins-core:${DOCKER_TAG}
    - docker push boonai/plugins-analysis:${DOCKER_TAG}
    - docker push boonai/analyst:${DOCKER_TAG}
    - docker push boonai/ml-bbq:${DOCKER_TAG}
    - docker push boonai/plugins-train:${DOCKER_TAG}
    - docker push boonai/wallet:${DOCKER_TAG}
    - docker push boonai/reporter:${DOCKER_TAG}
    - docker push boonai/metrics:${DOCKER_TAG}
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual

boonai-deploy-prod:
  image: google/cloud-sdk
  variables:
    PROJECT: zvi-prod
  stage: deploy
  environment:
    name: prod
    url: https://console.zvi.zorroa.com/
  before_script:
    - echo $PROD_SA_JSON > ./sa.json
    - gcloud auth activate-service-account $SA_EMAIL --key-file=./sa.json
    - gcloud container clusters get-credentials zmlp --zone us-central1-a --project ${PROJECT}
  script:
    - kubectl --namespace default rollout restart deployment wallet analyst api-gateway archivist auth-server officer ml-bbq reporter metrics
    - kubectl --namespace default rollout restart statefulset elasticsearch-master elasticsearch-data
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual

# Kotlin services - Unit tests - Step 1
boonai-services-build-artifacts:
  image: maven:3.6-jdk-11-slim
  stage: build
  script:
    - cd services/elasticsearch
    - mvn clean install -Dmaven.test.skip=true -Dhttp.keepAlive=false
  artifacts:
    paths:
      - services/elasticsearch/es-similarity/target/releases/es-similarity.zip
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # MR to any branch that is not master with Boon AI changes
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "master"
      changes:
        - "services/analyst/**/*"
        - "services/api-gateway/**/*"
        - "services/archivist/**/*"
        - "services/auth-server/**/*"
        - "services/elasticsearch/**/*"
        - "services/mlbbq/**/*"
        - "services/officer/**/*"
        - "services/reporter/**/*"
        - "services/jvm-common/**/*"
    # MR to QA with any change
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"
      changes:
        - "**/*"

# Kotlin services - Unit tests - Step 2
elasticsearch-push-to-local-registry:
  image: docker:18.09.8-dind
  stage: pretest
  retry: 2
  services:
    - docker:18.09.8-dind
  script:
    - cd services/elasticsearch
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - docker build -t $LOCAL_ES_NAME .
    - docker push $LOCAL_ES_NAME
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # MR to any branch that is not master with Boon AI changes
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "master"
      changes:
        - "services/analyst/**/*"
        - "services/api-gateway/**/*"
        - "services/archivist/**/*"
        - "services/auth-server/**/*"
        - "services/elasticsearch/**/*"
        - "services/mlbbq/**/*"
        - "services/officer/**/*"
        - "services/reporter/**/*"
    # MR to QA with any change
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"
      changes:
        - "**/*"

boonai-services-unit-tests:
  stage: test
  image: boonai/jvm-build:latest
  retry: 1
  services:
    - name: redis:alpine
      alias: redis
    - name: minio/minio
      alias: minio
      command: ["server", "/data"]
    - name: postgres:9.6.9
      alias: postgres
    - name: $LOCAL_ES_NAME
      alias: elasticsearch
      command: ["bin/elasticsearch", "-Ediscovery.type=single-node"]
  variables:
    POSTGRES_PASSWORD: "zorroa"
    POSTGRES_USER: "zorroa"
    POSTGRES_DB: "zorroa"
    PGDATA: "/var/lib/postgresql/data/pgdata"
    ARCHIVIST_ES_URL: "http://localhost:9200"
    SPRING_DATASOURCE_URL: "jdbc:postgresql://localhost:5432/zorroa?currentSchema=archivist_test"
    LOGGING_LEVEL_COM_ZORROA: "WARN"
    USER: "gitlab"
    BOONAI_STORAGE_PROJECT_ACCESSKEY: "qwerty123"
    BOONAI_STORAGE_PROJECT_SECRETKEY: "123qwerty"
    BOONAI_STORAGE_PROJECT_URL: "http://localhost:9000"
    BOONAI_STORAGE_SYSTEM_ACCESSKEY: "qwerty123"
    BOONAI_STORAGE_SYSTEM_SECRETKEY: "123qwerty"
    BOONAI_STORAGE_SYSTEM_URL: "http://localhost:9000"
    BOONAI_STORAGE_CLIENT: "minio"
    MINIO_ACCESS_KEY: "qwerty123"
    MINIO_SECRET_KEY: "123qwerty"
    MXNET_OS: "linux"
    MINIO_URL: "http://localhost:9000"
    MINIO_DEFAULT_PROTOCOL: "http"
    ARCHIVIST_ES_BACKUP_BUCKET_NAME: "project-storage-test"
    REDIS_HOST: "localhost:6379"
    MAVEN_OPTS: "-Dhttps.protocols=TLSv1.2 -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"
    MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true"
  script:
    - export
    - IP="$(cat /etc/hosts |grep $HOSTNAME|cut -d$'\t' -f1)"
    - ARCHIVIST_ES_URL="http://${IP}:9200"
    - BOONAI_STORAGE_PROJECT_URL="http://${IP}:9000"
    - BOONAI_STORAGE_SYSTEM_URL="http://${IP}:9000"
    - mvn clean install -f services/jvm-common -q -Dmaven.test.skip=true -Dhttp.keepAlive=false
    - mvn test verify -f services/jvm-common -
    - mvn clean install -f services/officer -q -Dmaven.test.skip=true -Dhttp.keepAlive=false
    - mvn test verify -f services/officer -q
    - mvn clean install -f services/archivist -q -Dmaven.test.skip=true -Dhttp.keepAlive=false
    - mvn test verify -f services/archivist -q
    - SPRING_DATASOURCE_URL="jdbc:postgresql://localhost:5432/zorroa?currentSchema=auth_test"
    - mvn clean install -f services/auth-server -q -Dmaven.test.skip=true -Dhttp.keepAlive=false
    - mvn test verify -f services/auth-server -q
  rules:
    # Scheduled Pipelines
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    # MR to any branch that is not master with Boon AI changes
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME != "master"
      changes:
        - "services/analyst/**/*"
        - "services/api-gateway/**/*"
        - "services/archivist/**/*"
        - "services/auth-server/**/*"
        - "services/elasticsearch/**/*"
        - "services/mlbbq/**/*"
        - "services/officer/**/*"
        - "services/reporter/**/*"
        - "services/jvm-common/**/*"
    # MR to QA with any change
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "qa"
      changes:
        - "**/*"
